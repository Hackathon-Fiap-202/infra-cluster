name: Deploy Infra AWS (Unified Root Module - 2 Fases)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  CLUSTER_NAME: nextime-frame-cluster

jobs:
  # =============================================================================
  # FASE 1: Deploy do Cluster (sem bootstrap)
  # =============================================================================
  deploy-cluster:
    name: Deploy - Fase 1 (Cluster)
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-action-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Plan - Fase 1 (Cluster apenas)
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -var="enable_bootstrap_addons=false" \
            -out=tfplan-fase1

      - name: Terraform Apply - Fase 1 (Cluster)
        id: apply_cluster
        run: |
          terraform apply -auto-approve tfplan-fase1
          echo "cluster_created=true" >> $GITHUB_OUTPUT

      - name: Verificar Cluster Criado
        if: steps.apply_cluster.outputs.cluster_created == 'true'
        run: |
          echo "## âœ… Fase 1 ConcluÃ­da" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cluster EKS criado com sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster**: ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**RegiÃ£o**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY

  # =============================================================================
  # FASE 2: Deploy do Bootstrap (addons)
  # =============================================================================
  deploy-bootstrap:
    name: Deploy - Fase 2 (Bootstrap)
    runs-on: ubuntu-latest
    needs: deploy-cluster
    environment: production

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-action-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Configure kubectl
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Aguardar cluster ficar pronto
        run: |
          echo "Aguardando nodes ficarem prontos..."
          kubectl wait --for=condition=Ready nodes --all --timeout=600s || true

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Plan - Fase 2 (Com Bootstrap)
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -var="enable_bootstrap_addons=true" \
            -out=tfplan-fase2

      - name: Terraform Apply - Fase 2 (Bootstrap)
        id: apply_bootstrap
        run: |
          terraform apply -auto-approve tfplan-fase2
          echo "bootstrap_created=true" >> $GITHUB_OUTPUT

      - name: Verificar estado do cluster
        if: steps.apply_bootstrap.outputs.bootstrap_created == 'true'
        run: |
          echo "## ðŸŽ¯ VerificaÃ§Ã£o do Cluster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Nodes" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY || echo "Erro ao obter nodes" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pods (todos os namespaces)" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -A >> $GITHUB_STEP_SUMMARY || echo "Erro ao obter pods" >> $GITHUB_STEP_SUMMARY

      - name: Verificar Addons Core
        if: steps.apply_bootstrap.outputs.bootstrap_created == 'true'
        run: |
          echo "## ðŸ“¦ Addons Core" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ArgoCD" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n argocd >> $GITHUB_STEP_SUMMARY || echo "ArgoCD nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### External Secrets" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n external-secrets >> $GITHUB_STEP_SUMMARY || echo "External Secrets nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Summary
        if: steps.apply_bootstrap.outputs.bootstrap_created == 'true'
        run: |
          echo "## ðŸŽ‰ Deploy Completo ConcluÃ­do!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Fase 1**: Cluster EKS criado" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Fase 2**: Bootstrap addons instalados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **MÃ³dulos implantados**:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… module.cluster - EKS Cluster" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… module.bootstrap_core - IRSA + Addons Core" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… module.bootstrap_addons - Datadog + Secrets" >> $GITHUB_STEP_SUMMARY
