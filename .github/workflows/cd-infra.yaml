name: Deploy Infra AWS (Unified Root Module)

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  CLUSTER_NAME: nextime-frame-cluster

jobs:
  terraform-apply:
    name: Deploy - Infraestrutura Completa
    runs-on: ubuntu-latest
    environment: production  # ProteÃ§Ã£o adicional para deploy em prod

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
          terraform_wrapper: false  # Para obter outputs limpos

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-action-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive || true

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: terraform plan -var-file=terraform.tfvars -out=tfplan

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -auto-approve tfplan
          echo "apply_success=true" >> $GITHUB_OUTPUT

      - name: Configure kubectl (apÃ³s cluster ser criado)
        if: steps.apply.outputs.apply_success == 'true'
        run: |
          aws eks update-kubeconfig \
            --name ${{ env.CLUSTER_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Aguardar cluster ficar pronto
        if: steps.apply.outputs.apply_success == 'true'
        run: |
          echo "Aguardando nodes ficarem prontos..."
          kubectl wait --for=condition=Ready nodes --all --timeout=600s || true

      - name: Verificar estado do cluster
        if: steps.apply.outputs.apply_success == 'true'
        run: |
          echo "## ðŸŽ¯ VerificaÃ§Ã£o do Cluster" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Nodes" >> $GITHUB_STEP_SUMMARY
          kubectl get nodes >> $GITHUB_STEP_SUMMARY || echo "Erro ao obter nodes" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pods (todos os namespaces)" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -A >> $GITHUB_STEP_SUMMARY || echo "Erro ao obter pods" >> $GITHUB_STEP_SUMMARY

      - name: Verificar Addons Core
        if: steps.apply.outputs.apply_success == 'true'
        run: |
          echo "## ðŸ“¦ Addons Core" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ArgoCD
          echo "### ArgoCD" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n argocd >> $GITHUB_STEP_SUMMARY || echo "ArgoCD nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
          
          # External Secrets
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### External Secrets" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n external-secrets >> $GITHUB_STEP_SUMMARY || echo "External Secrets nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
          
          # AWS Load Balancer Controller
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### AWS Load Balancer Controller" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n kube-system -l app.kubernetes.io/name=aws-load-balancer-controller >> $GITHUB_STEP_SUMMARY || echo "LB Controller nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY

      - name: Verificar Addons Adicionais
        if: steps.apply.outputs.apply_success == 'true'
        run: |
          echo "## ðŸ”§ Addons Adicionais" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Datadog
          echo "### Datadog" >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n default -l app=datadog >> $GITHUB_STEP_SUMMARY || echo "Datadog nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY
          
          # ClusterSecretStore
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ClusterSecretStore" >> $GITHUB_STEP_SUMMARY
          kubectl get clustersecretstore >> $GITHUB_STEP_SUMMARY || echo "ClusterSecretStore nÃ£o encontrado" >> $GITHUB_STEP_SUMMARY

      - name: Obter Terraform Outputs
        if: steps.apply.outputs.apply_success == 'true'
        run: |
          echo "## ðŸ“¤ Terraform Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          terraform output >> $GITHUB_STEP_SUMMARY || echo "Erro ao obter outputs" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Summary
        if: steps.apply.outputs.apply_success == 'true'
        run: |
          echo "## ðŸŽ‰ Deploy ConcluÃ­do com Sucesso!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Cluster EKS**: ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **RegiÃ£o**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Backend State**: s3://nextime-frame-state-bucket/infra-kubernetes/infra.tfstate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **MÃ³dulos implantados**:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… module.cluster - EKS Cluster" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… module.bootstrap_core - IRSA + Addons Core" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… module.bootstrap_addons - Datadog + Secrets" >> $GITHUB_STEP_SUMMARY

      - name: Notificar falha
        if: failure()
        run: |
          echo "## âŒ Deploy Falhou" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verifique os logs acima para detalhes do erro." >> $GITHUB_STEP_SUMMARY
