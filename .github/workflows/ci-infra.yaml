name: Terraform Plan (Unified Root Module)

on:
  pull_request:
    branches:
      - dev
      - hom
      - main
  push:
    branches:
      - feature/**

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  CLUSTER_NAME: nextime-frame-cluster

jobs:
  terraform-plan-base:
    name: Plan - Fase 1 (Cluster)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-action-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan - Fase 1 (Cluster apenas)
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -var="enable_bootstrap_addons=false" \
            -out=tfplan-fase1

      - name: Upload Plan Fase 1
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-fase1
          path: tfplan-fase1
          retention-days: 5

  terraform-plan-bootstrap:
    name: Plan - Fase 2 (Bootstrap)
    runs-on: ubuntu-latest
    needs: terraform-plan-base

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-action-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init -upgrade

      - name: Terraform Plan - Fase 2 (Com Bootstrap)
        run: |
          terraform plan \
            -var-file=terraform.tfvars \
            -var="enable_bootstrap_addons=true" \
            -out=tfplan-fase2
        continue-on-error: true

      - name: Upload Plan Fase 2
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-fase2
          path: tfplan-fase2
          retention-days: 5

      - name: Plan Summary
        run: |
          echo "## ðŸ“Š Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Fase 1 - Cluster" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Plan concluÃ­do (cluster apenas)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Fase 2 - Bootstrap" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Plan concluÃ­do (com bootstrap addons)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **MÃ³dulos incluÃ­dos**:" >> $GITHUB_STEP_SUMMARY
          echo "- module.cluster (EKS Cluster)" >> $GITHUB_STEP_SUMMARY
          echo "- module.bootstrap_core (IRSA + Addons Core)" >> $GITHUB_STEP_SUMMARY
          echo "- module.bootstrap_addons (Datadog + Configs)" >> $GITHUB_STEP_SUMMARY
