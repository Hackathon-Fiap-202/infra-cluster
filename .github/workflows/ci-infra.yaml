name: Terraform Plan (Unified Root Module)

on:
  pull_request:
    branches:
      - dev
      - hom
      - main
  push:
    branches:
      - feature/**

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  CLUSTER_NAME: nextime-frame-cluster

jobs:
  terraform-plan:
    name: Plan - Infraestrutura Completa
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/github-action-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init -upgrade

      - name: Terraform Validate
        id: validate
        run: terraform validate

      - name: Check if EKS Cluster Exists
        id: check_cluster
        run: |
          if aws eks describe-cluster --name $CLUSTER_NAME --region $AWS_REGION > /dev/null 2>&1; then
            echo "cluster_exists=true" >> $GITHUB_OUTPUT
            echo "Cluster already exists."
          else
            echo "cluster_exists=false" >> $GITHUB_OUTPUT
            echo "Cluster does not exist yet."
          fi

      - name: Terraform Plan (Cluster First if Needed)
        id: plan
        run: |
          if [ "${{ steps.check_cluster.outputs.cluster_exists }}" = "false" ]; then
            echo "Running plan ONLY for module.cluster (first deploy)..."
            terraform plan \
              -target=module.cluster \
              -var-file=terraform.tfvars \
              -out=tfplan
          else
            echo "Running FULL plan..."
            terraform plan \
              -var-file=terraform.tfvars \
              -out=tfplan
          fi
        continue-on-error: true

      - name: Comment PR com resultado do Plan
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        env:
          PLAN: ${{ steps.plan.outputs.stdout }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${process.env.PLAN}
            \`\`\`

            </details>

            **Cluster Exists**: ${{ steps.check_cluster.outputs.cluster_exists }}
            **Pusher**: @${{ github.actor }}
            **Action**: ${{ github.event_name }}
            **Working Directory**: \`./\` (Root Module)`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Terraform Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan
          retention-days: 5

      - name: Plan Summary
        run: |
          echo "## üìä Plan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Terraform Format**: ${{ steps.fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Terraform Init**: ${{ steps.init.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Terraform Validate**: ${{ steps.validate.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **Terraform Plan**: ${{ steps.plan.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "üîé **Cluster Exists**: ${{ steps.check_cluster.outputs.cluster_exists }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **M√≥dulos inclu√≠dos**:" >> $GITHUB_STEP_SUMMARY
          echo "- module.cluster (EKS Cluster)" >> $GITHUB_STEP_SUMMARY
          echo "- module.bootstrap_core (IRSA + Addons Core)" >> $GITHUB_STEP_SUMMARY
          echo "- module.bootstrap_addons (Datadog + Configs)" >> $GITHUB_STEP_SUMMARY
